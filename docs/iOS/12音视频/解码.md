# 解码

## 解码思路

1. 解析数据（NALU Unit 流单元）I帧P帧B帧

   既然NALU，一个接一个，所以需要实时解码。

   首先需要对数据解析，分析NALU数据，前面4个字节时起始位，标识一个NALU的开始，所以从第5位才开始来获取，从第五位才是NALU数据类型。

   获取到第5位数据，转化为十进制，然后根据表格判断它的数据类型。

   判断好数据类型，才能将NALU送入解码器。SPS/PPS获取就可以了，是不需要解码的。

   `CVPixelBufferRef`保存的是解码后的数据或者未编码前的数据。

2. 初始化解码器

3. 将解析后的H264数据输入到解码器

4. 解码完成后的回调，输出解码数据

5. 解码数据显示，用到OpenGL ES

## 解码三个核心函数

1. 创建session，`VTDecompressionSessionCreate`
2. 解码一个frame，`VTDecompressionSessionDecodeFrame`
3. 销毁解码session，`VTDecompressionSessionInvalidate`

## 原理分析

H264原始码流由一个一个流数据（NALU）组成

- I帧：保留了一张完整视频帧，解码关键
- P帧：向前参考帧，差异数据，解码需要依赖I帧
- B帧：双向参考帧，解码时即需要I帧，也需要P帧

**如果H264码流中I帧错误或者丢失，就会导致错误传递，P帧B帧单独是完成不了解码工作，会产生花屏现象。**

**VideoToolBox硬编码H264帧（I帧），手动添加了SPS和PPS。所以解码时需要使用SPS/PPS数据来对解码器进行初始化。**