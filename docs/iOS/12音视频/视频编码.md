# 视频编码

直播捕捉到的视频信息，需要压缩（AAC/H264）

硬编码（AVFoundation已经实现）

**任何视频/音频的压缩都是针对冗余数据的压缩。**

## 数据冗余

视频压缩是针对数据冗余做的，只要接收端不会产生误解，就可以减少承载信息的数据量。

## 视频

- 内容元素
  - 图像信息（Image）
  - 音频（Audio）
  - 元信息（Metadata）
- 编码格式
  - Video：H264
  - Audio：AAC
- 容器封装
  - MP4、MOV、FLV、RM、RMVB、AVI

## 视频4个动作

1. 采集--视频源数据CVPixelBufferRef
2. 编码（硬编码VideoToolBox）--- NALU数据--- CMBlockBufferRef
3. 解码（硬解码VideoToolBox）--  NALU数据--- CVPixelBufferRef
4. 将数据显示到屏幕上（渲染）-- OpenGL ES视频渲染动作

## H264编码原理

### 1、帧内预测压缩，解决的是空域数据冗余问题

什么是空域数据：就是这幅图里数据在宽高空间内包含了很多颜色、光亮，**人的肉眼很难察觉的数据**，对于这些数据，我们可以认作冗余，直接压缩掉。有损压缩。

宏块预测模式信息得到预测图，通过预测图与原图的差得到一个结果（残差值），加上残差值就得到原图。

### 2、帧间预测压缩，解决的是时域冗余问题

摄像头在一段时间内所捕捉的数据没有较大变化，针对这**一时间内的相同数据压缩掉**，就叫时域数据压缩。

### 3、整数离散余弦变换（DCT），将空间上相关性变为频域上无关的数据然后进行量化

如果对傅里叶变换理解比较好的，对这个理解的比较快。傅里叶变换可以把一个复杂波形图变换成许多的正弦波，只是它们之间的频率不一样，振幅也不一样。如果它们在频率上没有一致性那么我们就可以对它进行压缩处理。

### 4、CABAC压缩：无损压缩

高频短码，低频长码，加上上下文。

## 视频

视频由视频帧组成，图像达到一秒16帧以上就认为是视频。

在网络传输时图片很大，一次传输不了一整张图片，所以每一个图片又可以分成很多片。片有片头（网络传输序号）和片数据。

每一片有很多一个宏块。宏块包括：宏块类型，宏块预测，残差数据。

宏块又可以分成子块。

宏块是H264编码的基本单位。每个宏块选择合适的模式。

编码完成后会得到一个一个的流单元NALU。
