# app角标问题

设置app的角标`[[UIApplication sharedApplication] setApplicationIconBadgeNumber:0];` 这句如果在AppDelegate中实现的话，那么打开app就会清空通知栏中的通知消息。

场景
远程推送，在收到消息的时候，希望改变App的BadgeNumber值，如果没有点击通知进入App，则BadgeNumbe值累加，如果点击了通知进入App，则BadgeNumber值减1或清0(根据iOS的系统而定)。

技术分析：
在收到远程推送的消息的时候，有以下三种情况需要考虑：

1. 程序在后台运行

2. 程序未运行

3. 程序运行在前台

原则上，应用在收到推送消息时，badge的值是由后台来控制的，但是，目前的大多数公司后端都不会实现这一功能。幸运的是，JPush服务器已经帮我们做了。

我们在JPush后台发布消息时，在可选设置中，设置badge的值为：+1，就可以让app端badge的值自动加1，这样，我们在app端用代码修改badge的值的时候，都需要同时用[JPUSHService setBadge:badgeNumber]修改Push后台记录的badge值，这样下次app收到推送消息时，显示的badge才是正确的。

如果要求对于程序在前台运行时，收到的通知也做处理，这时，我们可以将收到的远程推送通知，转换为本地推送通知，同时修改badge值，就可以了。

### 清除appIcon的推送数量（badgeNumber），并且在系统通知栏保留推送通知

以下文字转载自：[http://www.itdadao.com/articles/c15a380661p0.html](http://www.itdadao.com/articles/c15a380661p0.html)
一、iOS 11 此功能依然好用！！！直接对applicationIconBadgeNumber赋值为-1就行了。这行代码仅仅对iOS 11生效。

```
[UIApplication sharedApplication].applicationIconBadgeNumber = -1;
```
二、如果要兼容ios10，8，9.还是用之前老的办法吧，如下：
细心的同学会发现这样一个情况，当我们执行以下代码，appIcon上面的数字消除了，但是通知栏中所有的推送也会被清除。想看之前的push就看不到了

```
[UIApplication sharedApplication].applicationIconBadgeNumber = 0;
```
那么如何既让数字消失，又保留通知栏的推送信息呢？最后在StackOverFlow上面找到了一个解决方案，实现方式如下：
        首先添加下面的一个方法：

```
-(void)resetBageNumber{
    UILocalNotification *clearEpisodeNotification = [[UILocalNotification alloc] init];
    
    /*
     iOS 11后，直接设置badgeNumber不生效了。故先发一个静默push（即没有soundName和alert）。如果原来app的badge是0也无所谓。对于本地push0就是不操作。
     后面在applicationIconBadgeNumber = -1
     */
    clearEpisodeNotification.applicationIconBadgeNumber = [UIApplication sharedApplication].applicationIconBadgeNumber;
    [[UIApplication sharedApplication] scheduleLocalNotification:clearEpisodeNotification];
    clearEpisodeNotification.applicationIconBadgeNumber = -1;
    [[UIApplication sharedApplication] scheduleLocalNotification:clearEpisodeNotification];

}
```
使用以上的方式就能够成功的让appIcon上面的数字消除，但是却保留通知栏中的推送消息。

为什么使用这种方式就成功了呢？
这其实是利用了苹果系统的一个bug。打开远程推送一秒后发送一条本地推送，这条本地推送不携带任何的信息，但是applicationIconBadgeNumber却等于-1,看API中说如果applicationIconBadgeNumber为0，就相当于不做任何处理，但是等于-1的话就要做处理咯，但是系统无法显示-1，就只有不显示。不显示不等同于将applicationIconBadgeNumber置为0，因为applicationIconBadgeNumber=0的同时，系统会自动消除通知栏所有关于该应用的通知。这样就看起来实现了我们的功能。这其实也是利用iOS系统的一个bug吧。而且这个方法，badge的消失还自带动画。

三、最终代码如下：
```objective-c
#define IS_IOS11_LATER   ([[UIDevice currentDevice] deviceSystemMajorVersion] >= 11)

//不在appIcon上显示推送数量，但是在系统通知栏保留推送通知的方法
-(void)resetBageNumber{
    if(IS_IOS11_LATER){
        /*
         iOS 11后，直接设置badgeNumber = -1就生效了
         */
        [UIApplication sharedApplication].applicationIconBadgeNumber = -1;
    }else{
        UILocalNotification *clearEpisodeNotification = [[UILocalNotification alloc] init];
        clearEpisodeNotification.fireDate = [NSDate dateWithTimeIntervalSinceNow:(0.3)];
        clearEpisodeNotification.timeZone = [NSTimeZone defaultTimeZone];
        clearEpisodeNotification.applicationIconBadgeNumber = -1;
        [[UIApplication sharedApplication] scheduleLocalNotification:clearEpisodeNotification];
    }
}
```
**极光后台推送界面也可以直接设置badge。**