# 多态性和虚函数

- 封装、继承、多态（C++面向对象的三个重要特性）
- 向上类型转换
- 早绑定、晚绑定
- 虚函数
- 重写
- VTABLE、VPTR

多态是在继承的基础上通过向上类型转换同时使用虚函数。使用了虚函数，C++就做晚绑定。

例：

创建一个乐器类class

不同类别的乐器做成乐器类的子类：  弦乐器（琴，吉他）， 管乐器（小号）， 打击乐器（鼓）

管乐器 又分 木管乐器和铜管乐器

管乐器继承乐器

### 乐器基类

- 成员函数 play 参数是枚举（低音，中音，高音）

### 管乐器

继承乐器类

重写play方法

#### 全局函数

创建一个全局函数t，参数是乐器类，调用乐器类play某个音调（中调C）。

### 调用

创建一个管乐器对象，调用全局函数t参数传管乐器对象，因为全局函数t的参数是乐器类型，所以会向上类型转换。这里还是调用的乐器基类的play。

只需要把乐器基类中的play变成虚函数（前面加`virtual`）虚函数可以被重新定义，重写。这样全局函数t参数传管乐器对象，就会调用管乐器的play方法。这就实现了多态。

继承把继承下来的虚函数重写，重写的时候可以写virtual可以不写，一般不写。

木管乐和铜管乐继承管乐器，可以重写play方法。因为play方法是虚函数。

可以创建不同的乐器对象，调用全局函数t参数传不同的乐器对象，调用乐器对象的play方法。

多态就是同一个方法，不同的子类有各自的实现。

根据需要在一个类里面把更多的函数做成虚函数。

需要多态就做成虚函数。不需要多态就不需要做成虚函数。

## 早绑定 晚绑定

虚函数就是晚绑定。在运行的时候才判断调用哪个函数，而不是编译的时候。

早绑定是编译时进行绑定。编译时就知道函数如何调用。

## VTABLE、VPTR

C++实现晚绑定通过一个虚表，虚指针，在虚表里找方法。

一个类只要有虚函数，C++就会给这个类创建一个虚表VTABLE

子类继承基类，基类有虚函数，子类也会把虚函数继承下来。当这些类创建对象的时候，因为类有一个虚表，创建的对象里就有一虚指针VPTR，通过虚指针在运行的时候动态的查看虚表，在虚表里查找应该调用哪个函数。

C++内部使用的是虚表虚指针，实现晚绑定，体现多态。

C++为每一个有虚函数的类设置VTABLE初始化VPTR，为虚函数的调用插入一些代码。这些都是自动的。编程的时候只需要在基类里写virtual，子类里一般不写，写了显得多余。

使用了虚函数的类会比没有使用的稍微慢一点。

一般情况下，做面向对象编程可以多使用虚函数多态，不会慢。更好的程序设计，扩展性更强。



这样就可以不改变原来的类而改变方法的实现，继承添加新的类。调用的都是自己实现的方法。灵活可扩展性强的程序设计。